version: 2.1

workflows:
  workflow:
    jobs:
      - linux-test:
          name: PHP 7.3
          docker-image: cimg/php:7.3
          shared-tests: 4.x-dev
      - linux-test:
          name: PHP 7.4
          docker-image: cimg/php:7.4
          shared-tests: 4.x-dev
      - linux-test:
          name: PHP 8.0
          docker-image: cimg/php:8.0
          shared-tests: dev-main

jobs:
  linux-test:
    parameters:
      docker-image:
        type: string
      shared-tests:
        type: string

    docker:
      - image: <<parameters.docker-image>>
      - image: redis

    steps:
      - checkout
      - run:
          name: install phpredis
          command: |
            yes '' | sudo pecl install -f redis || true
            echo "extension=redis.so" | sudo tee -a $(php -r 'echo get_cfg_var("cfg_file_path");') >/dev/null
      - run:
          name: install dependencies
          command: composer install --no-progress
      - run:
          name: require appropriate shared tests package
          command: composer require --dev 'launchdarkly/server-sdk-shared-tests:<<parameters.shared-tests>>'
      - run: mkdir -p ./phpunit
      - run:
          name: run tests
          command: php vendor/bin/phpunit
      - store_test_results:
          path: ./phpunit
      - store_artifacts:
          path: ./phpunit
